#! /bin/bash -f

##########################################################################
#	prop_furin
#
#	predict propeptide cleavage using Furin-specific Neural Network
#
# Run ensemble of 4 networks
# Input=<in.how> (How-file)
# Output=Arginine(R), Lysine(K), average score, 4 individual scores
##########################################################################


# Synapse + DAT files :
#	

#	$PROPSYN/how_RK-furin-ABCsyn.dat
#	$PROPSYN/how_RK-furin-ABDsyn.dat
#	$PROPSYN/how_RK-furin-ACDsyn.dat
#	$PROPSYN/how_RK-furin-BCDsyn.dat
#	$PROPSYN/furin-ABC.syn
#	$PROPSYN/furin-ABD.syn
#	$PROPSYN/furin-ACD.syn
#	$PROPSYN/furin-BCD.syn


howfile=$1			# 
number=1			# process only single sequence
out_alph=qz			# output alphabet

#res	=S		# residue type
#fullres=Serine		# full residue name


# cross-valtidation subnames and corresponding window sizes/hidden units

synapse=(ABC ABD ACD BCD)
win=( 13  19  17  11)
hid=(  2   4   8   2)

##########################################################################
# Run HOW98 for each of the 4 dat/synapse files
##########################################################################

# <combi> refers to combinations:	1=ABC, 2=ABD, 3=ACD, 4=BCD


for combi in 1 2 3 4
do
	syn=$PROPSYN/furin-${synapse[$combi]}.syn
	winsize=${win[$combi]}
	hidden=${hid[$combi]}
# run system-specific HOW using the configuration parameters shown below

	$HOW98 << END_OF_HOW > $howfile.out.$combi
**************************************************************************
                HOW INPUT PARAMETERS (C) COPYRIGHT 1989-1998
**************************************************************************
**************************************************************************
 RUN IDENTIFICATION ******************************************************
**************************************************************************
TESTRUNID
(RUNID   ** RUN IDENTIFIER)
**************************************************************************
 NETWORK ARCHITECTURE ****************************************************
**************************************************************************
21
(NIALPH  ** NUMBER OF LETTERS IN THE INPUT ALPHABET)
2  
(NOALPH  ** NUMBER OF LETTERS IN THE OUTPUT ALPHABET)
$winsize
(NWSIZE  ** WINDOW SIZE IN LETTERS)
$hidden
(N2HID   ** NUMBER OF UNITS IN THE SECOND LAYER)
0
(N3HID   ** NUMBER OF UNITS IN THE THIRD LAYER)
0
(N4HID   ** NUMBER OF UNITS IN THE FOURTH LAYER)
3
(NLAYER  ** NUMBER OF LAYERS, INCLUDING INPUT AND OUTPUT)
-90
(ICOVER  ** SIZE OF RECEPTIVE FIELDS FOR NEURONS IN FIRST HIDDEN LAYER)
-2
(IHOLEL  ** LEFT POSITION OF HOLE IN WINDOW)
-1
(IHOLER  ** RIGHT POSITION OF HOLE IN WINDOW) 
-1 
(LENPOS  ** ADD SEQUENCE POSITION UNITS TO INPUT LAYER)
-1 
(LSIZE   ** ADD SEQUENCE SIZE UNITS TO INPUT LAYER)
6671
(MAXLEN  ** MAXIMAL SEQUENCE LENGTH FOR NORMALIZATION IN LSIZE MODE)
-1       
(LCOMPO  ** ADD COMPOSITION UNITS TO INPUT LAYER)
**************************************************************************
 MODE SELECTION **********************************************************
**************************************************************************
1
(MODE    ** SAMPLE OR HOMOLOGY (ONE-SEQUENCE-AT-TIME))
1
(INORM   ** IN SAMPLE MODE: FULL OR INCREMENTAL TRAINING)
-1
(IPRIM   ** SAMPLE/HOMOLOGY MODES: PRIMARY OR SECONDARY OUTPUT CATAGORIES)
-1
(IDIST   ** SAMPLE AND SECONDARY MODE: DISTANCE MATRIX OUTPUT OR NOT)
-1
(IVIRGN  ** SYNAPSES READ FROM FILE OR RANDOM)
**************************************************************************
 CODING ******************************************************************
**************************************************************************
FIVWMLCHYAGNRTPDEQSK
(LETIN   ** INPUT ALPHABET - INPUT CATEGORIES)
ACGT
(LETALT  ** ALTERNATIVE INPUT ALPHABET) FIVWMLCHYAGNRTPDEQSK
$out_alph
(LETOUT  ** OUTPUT ALPHABET - OUTPUT CATEGORIES)
1
(NRULES  ** NUMBER OF CONVERSION RULES FOR OUTPUT CATAGORIES)
A=A
(RULES   ** CONVERSION RULES FOR OUTPUT CATAGORIES)
0.1
(SATMIN  ** ZERO TRAINING TARGET VALUE)
0.9
(SATMAX  ** ONE TRAINING TARGET VALUE)
0.0
(OFFNUM  ** ZERO INPUT VALUE)
1.0
(ONNUM   ** ONE INPUT VALUE)
-32
(LENPAT  ** LENGTH OF INPUT CATEGORY PATTERNS)
**************************************************************************
 NETWORK INITIATION ******************************************************
**************************************************************************
0.1
(SYNFAC  ** ABSOLUTE VALUE FOR RANDOM SYNAPSES)
30
(CUTOFF  ** ABSOLUTE VALUE OF LIMIT FOR TRANSFER FUNCTION TABLE)
**************************************************************************
 INPUT FORMATS ***********************************************************
**************************************************************************
-1
(IDNA    ** USE DNA SEQUENCE (AND AMINO ACID SEQUENCE) AS NETWORK INPUT)
1
(ITMODE  ** READ SECONDARY- AND/OR DM INPUT FROM TEST FILE - 0,1,2)
**************************************************************************
 LEARNING AND TEST PARAMETERS ********************************************
**************************************************************************
0.05
(ETA     ** LEARNING RATE)
1
(ICETA   ** SEPARATE LEARNING RATE FOR EACH CATEGORY)
0.0
(ALPHA   ** MOMENTUM STRENGTH)
50
(LSTOP   ** MAXIMAL NUMBER OF TRAINING SWEEPS) 
1 1 1 1 1 1 1 1 1 1 1 1
(IRPEAT  ** NUMBER OF BACKPROP REPEATS WITH SAME INPUT (NOALPH VALUES))
1
(ITEST   ** TEST FREQUENCY)
0.01
(BPLIM   ** ABSOLUTE VALUE FOR BACKPROPAGATION TO TAKE PLACE)
99.999
(CLIMIT  ** WHEN LEARNING SAMPLE IS INCREMENTED (NORMAL OUTPUT SUCCESS)
99.0
(DLIMIT  ** WHEN LEARNING SAMPLE IS INCREMENTED (DISTANCE OUTPUT SUCCESS)
1
(IRAN    ** LEARNING SAMPLE SHUFFLE)
4
(IPIECE  ** INCREMENTAL LEARNING MODE: NUMBER OF PARTS IN LEARNING SAMPLE)
-1
(IEUP    ** SYNAPS UPDATE: SAMPLE OR SINGLE WINDOW CONFIGURATION) 
5432199 
(ISSEED  ** SYNAPS INITIALISATION SEED)
**************************************************************************
 LEARNING AND TEST SAMPLES ***********************************************
**************************************************************************
0
(LEARNC  ** NUMBER OF SEQUENCES IN TRAINING FILE)
0
(LSKIP   ** NUMBER OF SEQUENCES TO SKIP IN TRAINING FILE)
-1
(IFULL   ** REDUCE THE SEQUENCES TO FULL WINDOW CONFIGURATIONS)
-1
(IREDUC  ** REDUCE THE TRAINING TO SUBSEQUENCES OF SPECIFIC SITES)
20
(ILEFT   ** THE NUMBER OF LETTERS TO THE LEFT OF EACH SPECIFIC SITE)
20
(IRIGHT  ** THE NUMBER OF LETTERS TO THE RIGHT OF EACH SPECIFIC SITE)
S
(LREDUC  ** THE OUTPUT LETTER CENTRAL IN SPECIFIC SITE REDUCTION)
$number 
(TESTC   ** NUMBER OF SEQUENCES IN TEST FILE)
0
(ITSKIP  ** NUMBER OF SEQUENCES TO SKIP IN TEST FILE)
**************************************************************************
 EVALUATION OF NETWORK OUTPUT ********************************************
**************************************************************************
2
(MEVAL   ** EVAL MODE, 1:WINNER-TAKE-ALL, 2:VARIABLE FIRST LETTER CUTOFF)
0.5
(EVAL    ** ASSIGNMENT CUTOFF FOR THE FIRST LETTER /0.0 - 1.0/  
1
(IWIN    ** FOR NETS=2, 1:HIGHEST ACTIVITY OUTPUT, 2:LETOUT(1) OR OUTPUT
**************************************************************************
 OUTPUT LEVELS AND FREQUENCIES *******************************************
**************************************************************************
1000
(ISYN    ** SYNAPS DUMP FREQUENCY WHEN >0; WHEN <0 DUMP WHEN CC INCREASES)
1000
(IHIST   ** SYNAPS HISTOGRAM GENERATION FREQUENCY) 
-1
(ICPER   ** PERCENTAGE OUTPUT FOR EVERY EXAMPLE)
-1
(ICSEQ   ** SEQUENCE OUTPUT FOR EVERY EXAMPLE)
-1
(ICANSW  ** CATEGORY STATISTICS FOR EVERY EXAMPLE)
1
(IANSW   ** CATEGORY STATISTICS FOR SAMPLES)
-1
(I1LET   ** FIRST LETTER DEVIATION - SAMPLES AND/OR EXAMPLES)
1
(ICOR    ** COMPUTATION OF CORRELATION COEFFICIENTS)  
1
(IACTIV  ** SINGLE WINDOW OUTPUT ACTIVITIES, TEST ONLY)
-1
(IWHERE  ** TEST: LOCALIZATION OF MATCH)
-1
(IQUAL   ** TEST: CONFIDENCE LEVELS)
-1
(ILEVEL  ** WRITE OUTPUT NEURON ACTIVITIES ON FILE)
-1
(IAFILE  ** WRITE OUTPUT CATEGORY ASSIGNMENTS ON FILE)
-1
(ILIST   ** WRITE LEARNT SUBSEQUENCES OF SPECIFIC SITES ON FILE)
-1
(IDMOUT  ** TEST: FULL DISTANCE MATRIX OUTPUT) 
**************************************************************************
 INPUT/OUTPUT FILE NAMES *************************************************
**************************************************************************
$syn
(SYNFIL  ** SYNAPS FILE NAME)
$howfile
(TESFIL  ** TEST SEQUENCE CODE FILE NAME)
$howfile
(LEAFIL  ** LEARN SEQUENCE CODE FILE NAME)
levels.dat
(LEVFIL  ** ACTIVITY LEVELS FILE NAME)
record.dat 
(RECFIL  ** CATEGORY ASSIGNMENT FILE NAME)
record.dat 
(DNFIL   ** LEARNT SUBSEQUENCE FILE NAME) 
pat_13.dat
(PATFIL  ** INPUT CATEGORY PATTERN FILE NAME) 
**************************************************************************
**************************************************************************
END_OF_HOW

done  	# end of 'foreach' loop

#wait 	# wait for all 5 processes


# format of the HOW98 output
#       1 M z z  0.066 0.935
#       2 E z z  0.010 0.990
# ...

#cat $howfile.out.*





##########################################################################
# Extract scores
##########################################################################


for combi in 1 2 3 4
do
	grep '[R|K] [zq] [zq]' $howfile.out.$combi |	\
	gawk '{print $5}'> $howfile.$combi.score
done

#grep '[R|K] [zq] [zq]' $howfile.out.1 	|\
#gawk '{print $1,$2,$3,$4,$5}' > $howfile.out.1.header

#paste $howfile.out.1.header $howfile.2.score $howfile.3.score $howfile.4.score

#exit




###########################################################################
# Extract sequence name from HOW-file (not shown in HOW98 output)
###########################################################################

seqname=`egrep '[0-9] [A-Za-z0-9]' $howfile|gawk '{print $2}' `

###########################################################################
# Extract Position, Residue type. Print Seqname, Position, Residue
# 	Paste with score-files for 4 networks.
###########################################################################


egrep '[R|K] [zq] [zq]' $howfile.out.1 | 			\
gawk -v seqn=$seqname '{print seqn, $1,$2}' > $howfile.name

paste 	$howfile.name $howfile.1.score $howfile.2.score		\
	$howfile.3.score $howfile.4.score		>	\
	$howfile.allscores
	
	

############################################################################
# Make sum of all 4 scores, calculate average. Print nicely.
############################################################################
 
cat $howfile.allscores| gawk '{sum=$4+$5+$6+$7;						\
	printf "%-14s %6d %2s %7.3f %3s %5.3f %7.3f %7.3f %7.3f %3s\n",  			\
	$1,$2,$3,sum/4," ( ",$4,$5,$6,$7," ) "}' | 						\
	gawk -v predict=ProP '{if ($4>= 0.5) print $0,"*"predict"*"; else print $0,"."}' > 	\
	$howfile.scoretable

#cat $howfile.scoretable
#exit



############################################################################
# Get 9-mer sequence windows for each position ($2) using <getseqstr>
############################################################################

rm -f $howfile.windows			# make sure file does not exist

gawk -f $PROPBIN/getseqstr $howfile >$howfile.seqstr

for val in `cat $howfile.scoretable | gawk '{print $2;}'`
do
	cat $howfile.seqstr | gawk -v V=$val '{print substr($1,V,7)"|"substr($1,V+7,2);}' \
		>>$howfile.windows
done

touch $howfile.windows

# if $howfile.windows is empty, $howfile contains no R or K residues

if [ -s $howfile.windows ]
then 
	paste $howfile.scoretable $howfile.windows > $howfile.scoretable.ex
	mv $howfile.scoretable.ex $howfile.scoretable
fi

############################################################################
# if Verbose, dump all data, otherwise show only average scores
############################################################################

if [ $v_opt -eq 1 ]
then			# Verbose option selected
	cat $howfile.scoretable			

elif [ -s $howfile.windows ]
then 		# Sequence does contain residues
						# of type R/K
						

	echo ''            
	echo 'Name           Pos    Context     Score  Pred'
        echo '_____________________________v_________________'

	cat $howfile.scoretable|						\
	gawk '{printf "%-12s %5d %13s %6.3f %4s\n", $1,$2,$12,$4,$11}'
        echo '_____________________________^_________________'
	echo ''

fi

exit

############################################################################
# end of script
############################################################################

for combi in ABC ABD ACD BCD
do
	cat $PROPSYN/how_RK-furin-${combi}syn.dat|	\
	sed 's/HOWFILENAME/${howfile}/g'		

#	$HOW98 > $howfile.out.$combi			
done

# format of the HOW98 output
#       1 M z z  0.066 0.935
#       2 E z z  0.010 0.990
# ...

cat $howfile.out.*

exit

